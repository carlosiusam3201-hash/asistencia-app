<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Asistencia - CULTURA DIGITAL II</title>
        <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a2980">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(to right, #1a2980, #26d0ce);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        
        h3 {
            color: #34495e;
            margin-bottom: 15px;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .section {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }
        
        .btn {
            background: linear-gradient(to right, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 14px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(to right, #27ae60, #219653);
        }
        
        .btn-success:hover {
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(to right, #f39c12, #e67e22);
        }
        
        .btn-warning:hover {
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(to right, #e74c3c, #c0392b);
        }
        
        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        .btn-large {
            padding: 16px 30px;
            font-size: 18px;
        }
        
        .grupos-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .grupo-btn {
            padding: 20px 10px;
            background-color: #1a2980;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .grupo-btn:hover {
            background-color: #26d0ce;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .grupo-btn.active {
            background-color: #27ae60;
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.3);
        }
        
        .grupo-info {
            background-color: #d1ecf1;
            border-left: 5px solid #17a2b8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .grupo-desc {
            font-size: 12px;
            margin-top: 5px;
            opacity: 0.8;
        }
        
        .grupo-alumnos {
            font-size: 12px;
            margin-top: 5px;
            color: #27ae60;
            font-weight: bold;
        }
        
        .hidden {
            display: none !important;
        }
        
        .alumnos-container {
            max-height: 500px;
            overflow-y: auto;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            background-color: white;
        }
        
        .alumno-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .alumno-item:hover {
            background-color: #f8f9fa;
        }
        
        .alumno-item.selected {
            background-color: #d4edda;
            border-left: 5px solid #28a745;
        }
        
        .alumno-checkbox {
            margin-right: 15px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .alumno-info {
            flex: 1;
        }
        
        .alumno-numero {
            font-weight: bold;
            color: #1a2980;
            margin-right: 10px;
            min-width: 30px;
        }
        
        .alumno-nombre {
            font-weight: 500;
        }
        
        .actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .asistencia-summary {
            margin-top: 30px;
            padding: 20px;
            background-color: #f1f8e9;
            border-radius: 10px;
            border-left: 5px solid #7cb342;
        }
        
        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .attendance-table th {
            background-color: #1a2980;
            color: white;
            padding: 12px;
            text-align: left;
            position: sticky;
            top: 0;
        }
        
        .attendance-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #ddd;
        }
        
        .attendance-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .present {
            background-color: #d4edda !important;
            color: #155724;
            font-weight: bold;
        }
        
        .absent {
            background-color: #f8d7da !important;
            color: #721c24;
            font-weight: bold;
        }
        
        .date-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e8f4fc;
            border-radius: 8px;
            flex-wrap: wrap;
        }
        
        .date-label {
            font-weight: 600;
            color: #1a2980;
        }
        
        .date-input {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .dia-info {
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 14px;
            border-top: 1px solid #eee;
            margin-top: 20px;
        }
        
        .back-btn {
            margin-bottom: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            color: #1a2980;
            font-size: 18px;
        }
        
        .file-input-container {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e8f4fc;
            border-radius: 8px;
        }
        
        .file-input-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #1a2980;
        }
        
        .file-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .stat-box {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1a2980;
        }
        
        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .stat-present {
            color: #28a745;
        }
        
        .stat-absent {
            color: #dc3545;
        }
        
        .report-options {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .report-btn {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            font-weight: 600;
            font-size: 16px;
        }
        
        .report-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .report-btn i {
            font-size: 24px;
            margin-bottom: 10px;
            display: block;
        }
        
        .date-range-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #ddd;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close-modal {
            float: right;
            font-size: 28px;
            cursor: pointer;
            color: #aaa;
        }
        
        .close-modal:hover {
            color: #000;
        }
        
        .grupo-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .grupo-option {
            padding: 15px 10px;
            background-color: #e8f4fc;
            border: 2px solid #3498db;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .grupo-option:hover {
            background-color: #d1ecf1;
            transform: translateY(-2px);
        }
        
        .grupo-option.selected {
            background-color: #27ae60;
            color: white;
            border-color: #219653;
        }
        
        .grupo-option.all {
            background-color: #f39c12;
            border-color: #e67e22;
            color: white;
        }
        
        .grupo-option.all.selected {
            background-color: #e67e22;
        }
        
        .report-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }
        
        .bulk-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .bulk-btn {
            padding: 10px 15px;
            background: linear-gradient(to right, #6c757d, #495057);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .bulk-btn:hover {
            background: linear-gradient(to right, #5a6268, #3d4348);
        }
        
        .bulk-btn-danger {
            background: linear-gradient(to right, #dc3545, #c82333);
        }
        
        .bulk-btn-danger:hover {
            background: linear-gradient(to right, #bd2130, #a71e2a);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-clipboard-check"></i> Sistema de Asistencia - CULTURA DIGITAL II</h1>
            <p>Registro de asistencia por grupo - Materia: CULTURA DIGITAL II</p>
        </header>
        
        <div class="main-content">
            <!-- Pantalla principal con grupos -->
            <div class="section" id="mainScreen">
                <h2>Seleccionar Grupo</h2>
                
                <div class="date-selector">
                    <span class="date-label">
                        <i class="fas fa-calendar-day"></i> Fecha de hoy:
                    </span>
                    <input type="date" id="currentDateInput" class="date-input" value="">
                    <button class="btn btn-success" id="setDate">
                        <i class="fas fa-calendar-check"></i> Establecer Fecha
                    </button>
                </div>
                
                <div class="dia-info" id="dateInfo">
                    <p><strong>Información:</strong> Selecciona un grupo para registrar la asistencia de hoy.</p>
                    <p id="currentDateDisplay">Fecha no establecida</p>
                </div>
                
                <h3>Grupos Disponibles</h3>
                <div class="grupos-container" id="gruposContainer">
                    <!-- Los grupos se cargarán dinámicamente -->
                </div>
                
                <div class="file-input-container">
                    <label class="file-input-label">
                        <i class="fas fa-file-excel"></i> Subir lista de alumnos para TODOS los grupos (Excel)
                    </label>
                    <input type="file" id="excelFileAll" class="file-input" accept=".xls,.xlsx">
                    <p style="margin-top: 10px; color: #666; font-size: 14px;">
                        Sube un archivo Excel con tres columnas: Grupo, Número y Nombre
                    </p>
                </div>
                
                <div class="file-input-container" id="uploadSection" style="display: none;">
                    <label class="file-input-label">
                        <i class="fas fa-file-excel"></i> Subir lista de alumnos para el grupo seleccionado (Excel)
                    </label>
                    <input type="file" id="excelFileSingle" class="file-input" accept=".xls,.xlsx">
                    <p style="margin-top: 10px; color: #666; font-size: 14px;">
                        Sube un archivo Excel con dos columnas: Número y Nombre
                    </p>
                </div>
                
                <div class="bulk-actions">
                    <button class="bulk-btn" id="loadAllLists">
                        <i class="fas fa-upload"></i> Cargar Listas de Ejemplo
                    </button>
                    <button class="bulk-btn bulk-btn-danger" id="deleteAllLists">
                        <i class="fas fa-trash"></i> Eliminar Todas las Listas
                    </button>
                </div>
                
                <div class="actions" id="attendanceActions" style="display: none;">
                    <button class="btn btn-success btn-large" id="takeAttendance">
                        <i class="fas fa-clipboard-check"></i> Tomar Asistencia
                    </button>
                </div>
                
                <div class="report-options">
                    <div class="report-btn" id="reportDiario">
                        <i class="fas fa-file-pdf"></i>
                        Reporte Diario PDF
                    </div>
                    <div class="report-btn" id="reportSemanal">
                        <i class="fas fa-file-pdf"></i>
                        Reporte Semanal PDF
                    </div>
                    <div class="report-btn" id="viewAllData">
                        <i class="fas fa-database"></i>
                        Ver Todos los Datos
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn btn-danger btn-large" id="clearData">
                        <i class="fas fa-trash"></i> Limpiar Datos del Grupo
                    </button>
                    <button class="btn btn-danger btn-large" id="clearAllData">
                        <i class="fas fa-trash-alt"></i> Limpiar TODOS los Datos
                    </button>
                </div>
                
                <div class="asistencia-summary">
                    <h3>Resumen de Asistencia de Hoy</h3>
                    <div id="dailySummary">
                        <p>No hay datos de asistencia registrados para hoy.</p>
                    </div>
                </div>
            </div>
            
            <!-- Pantalla de registro de asistencia -->
            <div class="section hidden" id="attendanceScreen">
                <button class="btn back-btn" id="backToMain">
                    <i class="fas fa-arrow-left"></i> Volver a Grupos
                </button>
                
                <h2 id="grupoTitle">Registrar Asistencia</h2>
                
                <div class="grupo-info" id="groupInfo">
                    <h3><i class="fas fa-users"></i> Grupo: <span id="displayGrupo"></span></h3>
                    <p>Materia: <strong>CULTURA DIGITAL II</strong></p>
                    <p>Fecha: <span id="displayDate"></span> | Hora: <span id="displayTime"></span></p>
                </div>
                
                <div class="stats" id="attendanceStats">
                    <div class="stat-box">
                        <div class="stat-value" id="totalAlumnos">0</div>
                        <div class="stat-label">Total Alumnos</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value stat-present" id="presentesCount">0</div>
                        <div class="stat-label">Presentes</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value stat-absent" id="ausentesCount">0</div>
                        <div class="stat-label">Ausentes</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="porcentajeAsistencia">0%</div>
                        <div class="stat-label">Porcentaje</div>
                    </div>
                </div>
                
                <div class="alumnos-container" id="alumnosList">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Sube una lista de alumnos o selecciona un grupo con datos existentes...
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn btn-success btn-large" id="selectAll">
                        <i class="fas fa-check-double"></i> Seleccionar Todos
                    </button>
                    <button class="btn btn-warning btn-large" id="deselectAll">
                        <i class="fas fa-times"></i> Deseleccionar Todos
                    </button>
                    <button class="btn btn-success btn-large" id="saveAttendance">
                        <i class="fas fa-save"></i> Guardar Asistencia
                    </button>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Sistema de Asistencia - CULTURA DIGITAL II | Período Agosto - Diciembre 2024 | © 2024</p>
        </footer>
    </div>
    
    <!-- Modal para reporte diario -->
    <div id="dailyReportModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Reporte Diario - CULTURA DIGITAL II</h2>
            
            <div class="date-selector">
                <span class="date-label">
                    <i class="fas fa-calendar-day"></i> Fecha:
                </span>
                <input type="date" id="reportDate" class="date-input" value="">
            </div>
            
            <div class="report-section">
                <h3>Seleccionar Grupo para el Reporte</h3>
                <div class="grupo-selector" id="reportGrupoSelector">
                    <div class="grupo-option all" data-grupo="TODOS">
                        <i class="fas fa-list"></i><br>
                        TODOS LOS GRUPOS
                    </div>
                    <!-- Los grupos se cargarán dinámicamente -->
                </div>
                
                <div class="actions" style="margin-top: 30px;">
                    <button class="btn btn-success btn-large" id="generateDailyReportBtn">
                        <i class="fas fa-file-pdf"></i> Generar Reporte Diario
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para reporte semanal -->
    <div id="weeklyReportModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Reporte Semanal - CULTURA DIGITAL II</h2>
            
            <div class="date-range-selector">
                <span class="date-label">
                    <i class="fas fa-calendar-week"></i> Seleccionar rango:
                </span>
                <input type="date" id="startDate" class="date-input" value="">
                <span>al</span>
                <input type="date" id="endDate" class="date-input" value="">
            </div>
            
            <div class="report-section">
                <h3>Seleccionar Grupo para el Reporte</h3>
                <div class="grupo-selector" id="weeklyGrupoSelector">
                    <div class="grupo-option all" data-grupo="TODOS">
                        <i class="fas fa-list"></i><br>
                        TODOS LOS GRUPOS
                    </div>
                    <!-- Los grupos se cargarán dinámicamente -->
                </div>
                
                <div class="actions" style="margin-top: 30px;">
                    <button class="btn btn-success btn-large" id="generateWeeklyReportBtn">
                        <i class="fas fa-file-pdf"></i> Generar Reporte Semanal
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para ver todos los datos -->
    <div id="dataModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Todos los Registros de Asistencia</h2>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // Variables globales
        let alumnosData = {};
        let attendanceData = [];
        let currentGrupo = null;
        let currentDate = '';
        let selectedReportGrupo = null;
        let selectedWeeklyGrupos = [];
        
        // Definición de los 9 grupos
        const gruposConfig = [
            { id: 'A', nombre: 'Grupo A', descripcion: '2°A Programación' },
            { id: 'B', nombre: 'Grupo B', descripcion: '2°B Programación' },
            { id: 'C', nombre: 'Grupo C', descripcion: '2°A Ciencia de Datos' },
            { id: 'D', nombre: 'Grupo D', descripcion: '2°A Inteligencia Artificial' },
            { id: 'E', nombre: 'Grupo E', descripcion: '2°A Contabilidad' },
            { id: 'F', nombre: 'Grupo F', descripcion: '2°B Contabilidad' },
            { id: 'G', nombre: 'Grupo G', descripcion: '2°C Contabilidad' },
            { id: 'H', nombre: 'Grupo H', descripcion: '2°A Comercio Internacional' },
            { id: 'I', nombre: 'Grupo I', descripcion: '2°B Comercio Internacional' }
        ];

        // Ejemplo de datos para todos los grupos
        const ejemploAlumnos = {
            'A': [
                { numero: 1, nombre: "ALONSO RUBIO ADRIANA LUCIA" },
                { numero: 2, nombre: "AMADOR DE LA GARZA DELMER HAMET" },
                { numero: 3, nombre: "ANTONIO DEL ANGEL CARLOS AURELIO" }
            ],
            'B': [
                { numero: 1, nombre: "BARAJAS RODRÍGUEZ YURIDIA BETZABETH" },
                { numero: 2, nombre: "BAUTISTA GALLEGOS LESLIE" },
                { numero: 3, nombre: "CAMPOS CADENA ANGEL GUADALUPE" }
            ],
            'C': [
                { numero: 1, nombre: "CASAS HERRERA DANA MICHELLE" },
                { numero: 2, nombre: "CASTAÑEDA FLORES ANGEL ESTEBAN" },
                { numero: 3, nombre: "CASTILLO GUERRA JOSE ALDAIR" }
            ],
            'D': [
                { numero: 1, nombre: "CASTILLO VAZQUEZ GILARI NICOLE" },
                { numero: 2, nombre: "CHAPA TORRES NELSON TADEO" },
                { numero: 3, nombre: "CHAVEZ VASQUEZ VIANEY" }
            ],
            'E': [
                { numero: 1, nombre: "CISNEROS NAJERA MARIANA YAMILETH" },
                { numero: 2, nombre: "CORTES DE LA ROSA JESE NEFTALI" },
                { numero: 3, nombre: "DE DIOS SANTOS PERLA ESPERANZA" }
            ],
            'F': [
                { numero: 1, nombre: "DE LA GARZA ZUÑIGA ANDRES GERARDO" },
                { numero: 2, nombre: "DIAZ RODRÍGUEZ JOHAN TADEO" },
                { numero: 3, nombre: "DIAZ TREJO BRUNO KALEL" }
            ],
            'G': [
                { numero: 1, nombre: "ESQUIVEL MORALES DAVID HASIEL" },
                { numero: 2, nombre: "GALINDO MARTÍNEZ ANDREA MAYTE" },
                { numero: 3, nombre: "GONZALEZ JUAREZ ILSE DANNALY" }
            ],
            'H': [
                { numero: 1, nombre: "GONZALEZ MARTINEZ ERICK ALFONSO" },
                { numero: 2, nombre: "GUADALUPE DEL ANGEL JOSE MAURICIO" },
                { numero: 3, nombre: "GUEVARA GUZMAN DANIEL IVAN" }
            ],
            'I': [
                { numero: 1, nombre: "HERNANDEZ SAN AGUSTIN BRENDA LIZBETH" },
                { numero: 2, nombre: "HERRERA BELTRAN DANIELA GALILEA" },
                { numero: 3, nombre: "JIMENEZ OVALLE ANGEL TADEO" }
            ]
        };
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar grupos
            initGrupos();
            
            // Establecer fecha por defecto (hoy)
            setDefaultDate();
            
            // Cargar datos guardados
            loadSavedData();
            
            // Configurar eventos
            document.getElementById('excelFileAll').addEventListener('change', handleFileUploadAll);
            document.getElementById('excelFileSingle').addEventListener('change', handleFileUploadSingle);
            document.getElementById('setDate').addEventListener('click', setCurrentDate);
            document.getElementById('takeAttendance').addEventListener('click', goToAttendanceScreen);
            document.getElementById('reportDiario').addEventListener('click', showDailyReportModal);
            document.getElementById('reportSemanal').addEventListener('click', showWeeklyReportModal);
            document.getElementById('viewAllData').addEventListener('click', showAllDataModal);
            document.getElementById('clearData').addEventListener('click', clearGrupoData);
            document.getElementById('clearAllData').addEventListener('click', clearAllData);
            document.getElementById('loadAllLists').addEventListener('click', loadExampleLists);
            document.getElementById('deleteAllLists').addEventListener('click', deleteAllLists);
            
            // Botones de la pantalla de asistencia
            document.getElementById('backToMain').addEventListener('click', backToMain);
            document.getElementById('selectAll').addEventListener('click', selectAllAlumnos);
            document.getElementById('deselectAll').addEventListener('click', deselectAllAlumnos);
            document.getElementById('saveAttendance').addEventListener('click', saveAttendance);
            
            // Configurar modales
            setupModals();
            
            // Actualizar grupos con información de alumnos
            updateGruposInfo();
        });
        
        // Inicializar grupos en la interfaz
        function initGrupos() {
            const container = document.getElementById('gruposContainer');
            container.innerHTML = '';
            
            gruposConfig.forEach(grupo => {
                const button = document.createElement('button');
                button.className = 'grupo-btn';
                button.dataset.grupo = grupo.id;
                button.id = `grupoBtn-${grupo.id}`;
                button.innerHTML = `
                    <i class="fas fa-users"></i><br>
                    <strong>${grupo.nombre}</strong><br>
                    <span class="grupo-desc">${grupo.descripcion}</span>
                    <div class="grupo-alumnos" id="alumnosCount-${grupo.id}">0 alumnos</div>
                `;
                button.addEventListener('click', selectGrupo);
                container.appendChild(button);
            });
            
            // También inicializar grupos en los modales de reportes
            initReportModals();
        }
        
        // Actualizar información de alumnos en los grupos
        function updateGruposInfo() {
            gruposConfig.forEach(grupo => {
                const countElement = document.getElementById(`alumnosCount-${grupo.id}`);
                if (countElement) {
                    const alumnos = alumnosData[grupo.id] || [];
                    countElement.textContent = `${alumnos.length} alumnos`;
                    
                    // Cambiar color si hay alumnos
                    if (alumnos.length > 0) {
                        countElement.style.color = '#27ae60';
                    } else {
                        countElement.style.color = '#666';
                    }
                }
            });
        }
        
        // Inicializar grupos en modales de reportes
        function initReportModals() {
            const dailySelector = document.getElementById('reportGrupoSelector');
            const weeklySelector = document.getElementById('weeklyGrupoSelector');
            
            // Limpiar selectores (excepto el botón TODOS)
            while (dailySelector.children.length > 1) {
                dailySelector.removeChild(dailySelector.lastChild);
            }
            while (weeklySelector.children.length > 1) {
                weeklySelector.removeChild(weeklySelector.lastChild);
            }
            
            // Agregar grupos
            gruposConfig.forEach(grupo => {
                // Para reporte diario
                const dailyOption = document.createElement('div');
                dailyOption.className = 'grupo-option';
                dailyOption.dataset.grupo = grupo.id;
                dailyOption.innerHTML = `
                    <i class="fas fa-users"></i><br>
                    ${grupo.nombre}
                `;
                dailySelector.appendChild(dailyOption);
                
                // Para reporte semanal
                const weeklyOption = document.createElement('div');
                weeklyOption.className = 'grupo-option';
                weeklyOption.dataset.grupo = grupo.id;
                weeklyOption.innerHTML = `
                    <i class="fas fa-users"></i><br>
                    ${grupo.nombre}
                `;
                weeklySelector.appendChild(weeklyOption);
            });
        }
        
        // Configurar todos los modales
        function setupModals() {
            // Modal de reporte diario
            const dailyModal = document.getElementById('dailyReportModal');
            const dailyClose = dailyModal.querySelector('.close-modal');
            const reportGrupoSelector = document.getElementById('reportGrupoSelector');
            
            dailyClose.onclick = function() {
                dailyModal.style.display = "none";
            }
            
            // Selección de grupo para reporte diario
            reportGrupoSelector.addEventListener('click', function(e) {
                const grupoOption = e.target.closest('.grupo-option');
                if (grupoOption) {
                    // Remover selección anterior
                    document.querySelectorAll('#reportGrupoSelector .grupo-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Seleccionar nueva opción
                    grupoOption.classList.add('selected');
                    selectedReportGrupo = grupoOption.dataset.grupo;
                }
            });
            
            // Botón para generar reporte diario
            document.getElementById('generateDailyReportBtn').addEventListener('click', generateDailyReport);
            
            // Modal de reporte semanal
            const weeklyModal = document.getElementById('weeklyReportModal');
            const weeklyClose = weeklyModal.querySelector('.close-modal');
            const weeklyGrupoSelector = document.getElementById('weeklyGrupoSelector');
            
            weeklyClose.onclick = function() {
                weeklyModal.style.display = "none";
            }
            
            // Selección múltiple para reporte semanal
            weeklyGrupoSelector.addEventListener('click', function(e) {
                const grupoOption = e.target.closest('.grupo-option');
                if (grupoOption) {
                    const grupo = grupoOption.dataset.grupo;
                    
                    if (grupo === 'TODOS') {
                        // Si se selecciona TODOS, deseleccionar todo y seleccionar solo TODOS
                        selectedWeeklyGrupos = ['TODOS'];
                        document.querySelectorAll('#weeklyGrupoSelector .grupo-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        grupoOption.classList.add('selected');
                    } else {
                        // Si se selecciona un grupo específico
                        if (selectedWeeklyGrupos.includes('TODOS')) {
                            selectedWeeklyGrupos = [];
                            document.querySelectorAll('#weeklyGrupoSelector .grupo-option').forEach(opt => {
                                opt.classList.remove('selected');
                            });
                        }
                        
                        if (selectedWeeklyGrupos.includes(grupo)) {
                            // Deseleccionar
                            const index = selectedWeeklyGrupos.indexOf(grupo);
                            selectedWeeklyGrupos.splice(index, 1);
                            grupoOption.classList.remove('selected');
                        } else {
                            // Seleccionar
                            selectedWeeklyGrupos.push(grupo);
                            grupoOption.classList.add('selected');
                        }
                    }
                }
            });
            
            // Botón para generar reporte semanal
            document.getElementById('generateWeeklyReportBtn').addEventListener('click', generateWeeklyReport);
            
            // Modal para ver todos los datos
            const dataModal = document.getElementById('dataModal');
            const dataClose = dataModal.querySelector('.close-modal');
            
            dataClose.onclick = function() {
                dataModal.style.display = "none";
            }
            
            // Cerrar modales al hacer clic fuera
            window.onclick = function(event) {
                if (event.target == dailyModal) {
                    dailyModal.style.display = "none";
                }
                if (event.target == weeklyModal) {
                    weeklyModal.style.display = "none";
                }
                if (event.target == dataModal) {
                    dataModal.style.display = "none";
                }
            }
        }
        
        // Establecer fecha por defecto (hoy) - CORREGIDO
        function setDefaultDate() {
            const today = new Date();
            // Ajustar para zona horaria local
            const localDate = new Date(today.getTime() - today.getTimezoneOffset() * 60000);
            const formattedDate = localDate.toISOString().split('T')[0];
            document.getElementById('currentDateInput').value = formattedDate;
            setCurrentDate();
        }
        
        // Establecer la fecha actual - CORREGIDO
        function setCurrentDate() {
            const dateInput = document.getElementById('currentDateInput').value;
            
            if (!dateInput) {
                alert('Por favor, selecciona una fecha');
                return;
            }
            
            // Guardar la fecha tal como está en el input (sin ajustes de zona horaria)
            currentDate = dateInput;
            
            // Formatear la fecha para mostrar (sin ajustes de zona horaria)
            const dateObj = new Date(dateInput + 'T00:00:00'); // Añadir hora para evitar ajuste de zona
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = dateObj.toLocaleDateString('es-MX', options);
            
            document.getElementById('currentDateDisplay').textContent = `Fecha: ${formattedDate}`;
            
            updateDailySummary();
        }
        
        // Seleccionar grupo
        function selectGrupo(event) {
            const grupoBtn = event.currentTarget;
            const grupoId = grupoBtn.dataset.grupo;
            
            // Remover clase active de todos los botones
            document.querySelectorAll('.grupo-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Agregar clase active al botón seleccionado
            grupoBtn.classList.add('active');
            
            // Establecer grupo actual
            currentGrupo = grupoId;
            
            // Mostrar sección de subida de archivo individual
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('attendanceActions').style.display = 'block';
            
            // Actualizar información del grupo
            const grupoInfo = gruposConfig.find(g => g.id === currentGrupo);
            if (grupoInfo) {
                // Verificar si ya hay datos de alumnos para este grupo
                const alumnos = alumnosData[currentGrupo] || [];
                if (alumnos.length > 0) {
                    document.getElementById('takeAttendance').innerHTML = 
                        `<i class="fas fa-clipboard-check"></i> Tomar Asistencia (${alumnos.length} alumnos cargados)`;
                } else {
                    document.getElementById('takeAttendance').innerHTML = 
                        `<i class="fas fa-clipboard-check"></i> Tomar Asistencia`;
                }
            }
        }
        
        // Ir a pantalla de asistencia
        function goToAttendanceScreen() {
            if (!currentGrupo) {
                alert('Por favor, selecciona un grupo primero');
                return;
            }
            
            if (!currentDate) {
                alert('Por favor, establece la fecha primero');
                return;
            }
            
            // Verificar si hay alumnos cargados para este grupo
            if (!alumnosData[currentGrupo] || alumnosData[currentGrupo].length === 0) {
                alert('Por favor, sube la lista de alumnos para este grupo primero');
                return;
            }
            
            // Actualizar título
            const grupoInfo = gruposConfig.find(g => g.id === currentGrupo);
            document.getElementById('grupoTitle').textContent = `Registrar Asistencia - ${grupoInfo.nombre}`;
            document.getElementById('displayGrupo').textContent = grupoInfo.nombre;
            
            // Mostrar fecha y hora actual
            updateDateTime();
            
            // Cambiar pantallas
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('attendanceScreen').classList.remove('hidden');
            
            // Cargar lista de alumnos
            loadAlumnosList();
        }
        
        // Manejar subida de archivo Excel para TODOS los grupos
        function handleFileUploadAll(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Obtener la primera hoja
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    // Procesar los datos del Excel para todos los grupos
                    processExcelDataAll(jsonData);
                } catch (error) {
                    alert('Error al leer el archivo Excel: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                alert('Error al leer el archivo');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // Manejar subida de archivo Excel para un grupo individual
        function handleFileUploadSingle(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!currentGrupo) {
                alert('Por favor, selecciona un grupo primero');
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Obtener la primera hoja
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    // Procesar los datos del Excel
                    processExcelDataSingle(jsonData, currentGrupo);
                } catch (error) {
                    alert('Error al leer el archivo Excel: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                alert('Error al leer el archivo');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // Procesar datos del Excel para todos los grupos
        function processExcelDataAll(data) {
            const gruposTemp = {};
            
            // Suponemos que el archivo tiene columnas: Grupo, Número, Nombre
            for (let i = 1; i < data.length; i++) { // Saltar encabezado
                const grupo = data[i][0];
                const numero = data[i][1];
                const nombre = data[i][2];
                
                // Verificar si la fila tiene datos
                if (grupo !== undefined && grupo !== null && grupo.toString().trim() !== '' &&
                    nombre !== undefined && nombre !== null && nombre.toString().trim() !== '') {
                    
                    const grupoId = grupo.toString().trim().toUpperCase();
                    
                    // Verificar si es un grupo válido
                    if (gruposConfig.find(g => g.id === grupoId)) {
                        if (!gruposTemp[grupoId]) {
                            gruposTemp[grupoId] = [];
                        }
                        
                        let num = parseInt(numero);
                        if (isNaN(num) || num <= 0) {
                            // Si no hay número válido, usar el índice
                            num = gruposTemp[grupoId].length + 1;
                        }
                        
                        gruposTemp[grupoId].push({
                            numero: num,
                            nombre: nombre.toString().trim()
                        });
                    }
                }
            }
            
            // Guardar alumnos para cada grupo
            let totalAlumnos = 0;
            let gruposProcesados = 0;
            
            for (const [grupoId, alumnos] of Object.entries(gruposTemp)) {
                if (alumnos.length > 0) {
                    alumnosData[grupoId] = alumnos;
                    totalAlumnos += alumnos.length;
                    gruposProcesados++;
                }
            }
            
            if (totalAlumnos === 0) {
                alert('No se encontraron alumnos en el archivo. Verifica el formato del archivo.');
                return;
            }
            
            saveData();
            
            alert(`Se cargaron ${totalAlumnos} alumnos en ${gruposProcesados} grupos`);
            
            // Actualizar información de los grupos
            updateGruposInfo();
            
            // Si hay un grupo seleccionado, actualizar su botón
            if (currentGrupo && alumnosData[currentGrupo]) {
                const alumnos = alumnosData[currentGrupo];
                document.getElementById('takeAttendance').innerHTML = 
                    `<i class="fas fa-clipboard-check"></i> Tomar Asistencia (${alumnos.length} alumnos cargados)`;
            }
        }
        
        // Procesar datos del Excel para un grupo individual
        function processExcelDataSingle(data, grupoId) {
            const nuevosAlumnos = [];
            
            // Buscar datos de alumnos (asumimos que la columna A tiene números y B tiene nombres)
            for (let i = 0; i < data.length; i++) {
                let nombre = data[i][1];
                let numero = data[i][0];
                
                // Verificar si la fila tiene datos
                if (nombre !== undefined && nombre !== null && nombre.toString().trim() !== '') {
                    let num = parseInt(numero);
                    if (isNaN(num) || num <= 0) {
                        // Si no hay número válido, usar el índice
                        num = nuevosAlumnos.length + 1;
                    }
                    
                    nuevosAlumnos.push({
                        numero: num,
                        nombre: nombre.toString().trim()
                    });
                }
            }
            
            if (nuevosAlumnos.length === 0) {
                alert('No se encontraron alumnos en el archivo. Verifica el formato del archivo.');
                return;
            }
            
            // Guardar alumnos para este grupo
            alumnosData[grupoId] = nuevosAlumnos;
            saveData();
            
            alert(`Se cargaron ${nuevosAlumnos.length} alumnos para el grupo ${grupoId}`);
            
            // Actualizar información del grupo
            updateGruposInfo();
            
            // Actualizar botón de tomar asistencia
            document.getElementById('takeAttendance').innerHTML = 
                `<i class="fas fa-clipboard-check"></i> Tomar Asistencia (${nuevosAlumnos.length} alumnos cargados)`;
        }
        
        // Cargar listas de ejemplo para todos los grupos
        function loadExampleLists() {
            if (confirm('¿Deseas cargar listas de ejemplo para todos los grupos?')) {
                // Copiar datos de ejemplo
                for (const [grupoId, alumnos] of Object.entries(ejemploAlumnos)) {
                    alumnosData[grupoId] = [...alumnos];
                }
                
                saveData();
                updateGruposInfo();
                
                alert('Listas de ejemplo cargadas para todos los grupos');
                
                // Si hay un grupo seleccionado, actualizar su botón
                if (currentGrupo && alumnosData[currentGrupo]) {
                    const alumnos = alumnosData[currentGrupo];
                    document.getElementById('takeAttendance').innerHTML = 
                        `<i class="fas fa-clipboard-check"></i> Tomar Asistencia (${alumnos.length} alumnos cargados)`;
                }
            }
        }
        
        // Eliminar todas las listas de alumnos
        function deleteAllLists() {
            if (confirm('¿Estás seguro de que deseas eliminar TODAS las listas de alumnos de todos los grupos? Esta acción no se puede deshacer.')) {
                // Limpiar todas las listas
                alumnosData = {};
                
                saveData();
                updateGruposInfo();
                
                // Resetear botón de tomar asistencia
                if (currentGrupo) {
                    document.getElementById('takeAttendance').innerHTML = 
                        `<i class="fas fa-clipboard-check"></i> Tomar Asistencia`;
                }
                
                alert('Todas las listas de alumnos han sido eliminadas');
            }
        }
        
        // Actualizar fecha y hora en tiempo real
        function updateDateTime() {
            const now = new Date();
            
            // Formatear fecha usando la fecha seleccionada (sin ajustes)
            const dateObj = new Date(currentDate + 'T00:00:00');
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = dateObj.toLocaleDateString('es-MX', dateOptions);
            
            // Formatear hora
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            const formattedTime = now.toLocaleTimeString('es-MX', timeOptions);
            
            document.getElementById('displayDate').textContent = formattedDate;
            document.getElementById('displayTime').textContent = formattedTime;
            
            // Actualizar cada segundo
            setTimeout(updateDateTime, 1000);
        }
        
        // Volver a pantalla principal
        function backToMain() {
            document.getElementById('attendanceScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            
            // Limpiar selección de grupo
            document.querySelectorAll('.grupo-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Ocultar sección de subida de archivo
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('attendanceActions').style.display = 'none';
            
            // Resetear grupo actual
            currentGrupo = null;
        }
        
        // Cargar lista de alumnos
        function loadAlumnosList() {
            const container = document.getElementById('alumnosList');
            
            if (!alumnosData[currentGrupo] || alumnosData[currentGrupo].length === 0) {
                container.innerHTML = '<div class="loading">No hay alumnos cargados para este grupo</div>';
                return;
            }
            
            let html = '';
            
            // Verificar si ya hay asistencia guardada para este grupo en esta fecha
            const existingAttendance = getExistingAttendance();
            
            alumnosData[currentGrupo].forEach(alumno => {
                const existingRecord = existingAttendance.find(a => 
                    a.numero === alumno.numero && 
                    a.nombre === alumno.nombre
                );
                
                const isPresent = existingRecord ? existingRecord.asistio : false;
                
                html += `
                    <div class="alumno-item ${isPresent ? 'selected' : ''}" data-numero="${alumno.numero}">
                        <input type="checkbox" class="alumno-checkbox" ${isPresent ? 'checked' : ''}>
                        <div class="alumno-info">
                            <span class="alumno-numero">${alumno.numero}.</span>
                            <span class="alumno-nombre">${alumno.nombre}</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Agregar eventos a los checkboxes
            document.querySelectorAll('.alumno-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        const checkbox = this.querySelector('.alumno-checkbox');
                        checkbox.checked = !checkbox.checked;
                        this.classList.toggle('selected', checkbox.checked);
                    }
                    updateStats();
                });
            });
            
            document.querySelectorAll('.alumno-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    this.parentElement.classList.toggle('selected', this.checked);
                    updateStats();
                });
            });
            
            updateStats();
        }
        
        // Obtener asistencia existente para este grupo en esta fecha
        function getExistingAttendance() {
            if (!currentGrupo || !currentDate) return [];
            
            return attendanceData.filter(record => 
                record.grupo === currentGrupo && 
                record.fecha === currentDate &&
                record.materia === 'CULTURA DIGITAL II'
            );
        }
        
        // Actualizar estadísticas
        function updateStats() {
            const total = alumnosData[currentGrupo] ? alumnosData[currentGrupo].length : 0;
            const presentes = document.querySelectorAll('.alumno-checkbox:checked').length;
            const ausentes = total - presentes;
            const porcentaje = total > 0 ? Math.round((presentes / total) * 100) : 0;
            
            document.getElementById('totalAlumnos').textContent = total;
            document.getElementById('presentesCount').textContent = presentes;
            document.getElementById('ausentesCount').textContent = ausentes;
            document.getElementById('porcentajeAsistencia').textContent = `${porcentaje}%`;
        }
        
        // Seleccionar todos los alumnos
        function selectAllAlumnos() {
            document.querySelectorAll('.alumno-checkbox').forEach(checkbox => {
                checkbox.checked = true;
                checkbox.parentElement.classList.add('selected');
            });
            updateStats();
        }
        
        // Deseleccionar todos los alumnos
        function deselectAllAlumnos() {
            document.querySelectorAll('.alumno-checkbox').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.parentElement.classList.remove('selected');
            });
            updateStats();
        }
        
        // Guardar asistencia
        function saveAttendance() {
            if (!currentGrupo || !currentDate) {
                alert('Error: No hay grupo o fecha seleccionada');
                return;
            }
            
            const timestamp = new Date().toISOString();
            
            // Eliminar registros anteriores de este grupo en esta fecha para esta materia
            attendanceData = attendanceData.filter(record => 
                !(record.grupo === currentGrupo && 
                  record.fecha === currentDate &&
                  record.materia === 'CULTURA DIGITAL II')
            );
            
            // Agregar nuevos registros
            document.querySelectorAll('.alumno-item').forEach(item => {
                const checkbox = item.querySelector('.alumno-checkbox');
                const numero = parseInt(item.dataset.numero);
                const nombre = item.querySelector('.alumno-nombre').textContent;
                
                attendanceData.push({
                    fecha: currentDate,
                    grupo: currentGrupo,
                    materia: 'CULTURA DIGITAL II',
                    numero: numero,
                    nombre: nombre,
                    asistio: checkbox.checked,
                    timestamp: timestamp
                });
            });
            
            saveData();
            alert(`Asistencia guardada para ${gruposConfig.find(g => g.id === currentGrupo).nombre} - ${formatDateForDisplay(currentDate)}`);
            updateDailySummary();
            backToMain();
        }
        
        // Formatear fecha para mostrar
        function formatDateForDisplay(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('es-MX', { weekday: 'short', day: 'numeric', month: 'short' });
        }
        
        // Actualizar resumen diario
        function updateDailySummary() {
            const container = document.getElementById('dailySummary');
            
            if (!currentDate) {
                container.innerHTML = '<p>No hay datos de asistencia registrados para hoy.</p>';
                return;
            }
            
            const todayAttendance = attendanceData.filter(record => 
                record.fecha === currentDate && 
                record.materia === 'CULTURA DIGITAL II'
            );
            
            if (todayAttendance.length === 0) {
                container.innerHTML = '<p>No hay datos de asistencia registrados para hoy.</p>';
                return;
            }
            
            // Agrupar por grupo
            const grupos = {};
            todayAttendance.forEach(record => {
                if (!grupos[record.grupo]) {
                    grupos[record.grupo] = {
                        presentes: 0,
                        ausentes: 0,
                        total: 0
                    };
                }
                
                if (record.asistio) {
                    grupos[record.grupo].presentes++;
                } else {
                    grupos[record.grupo].ausentes++;
                }
                grupos[record.grupo].total++;
            });
            
            let html = '<table class="attendance-table">';
            html += '<tr><th>Grupo</th><th>Presentes</th><th>Ausentes</th><th>Total</th><th>% Asistencia</th></tr>';
            
            for (const [grupoId, datos] of Object.entries(grupos)) {
                const grupoInfo = gruposConfig.find(g => g.id === grupoId);
                const nombreGrupo = grupoInfo ? grupoInfo.nombre : grupoId;
                const porcentaje = datos.total > 0 ? Math.round((datos.presentes / datos.total) * 100) : 0;
                
                html += `
                    <tr>
                        <td>${nombreGrupo}</td>
                        <td class="present">${datos.presentes}</td>
                        <td class="absent">${datos.ausentes}</td>
                        <td>${datos.total}</td>
                        <td>${porcentaje}%</td>
                    </tr>
                `;
            }
            
            html += '</table>';
            container.innerHTML = html;
        }
        
        // Mostrar modal para reporte diario
        function showDailyReportModal() {
            const modal = document.getElementById('dailyReportModal');
            
            // Establecer fecha por defecto
            document.getElementById('reportDate').value = currentDate || new Date().toISOString().split('T')[0];
            
            // Seleccionar "TODOS" por defecto
            document.querySelectorAll('#reportGrupoSelector .grupo-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector('#reportGrupoSelector .grupo-option.all').classList.add('selected');
            selectedReportGrupo = 'TODOS';
            
            modal.style.display = "block";
        }
        
        // Generar reporte diario en PDF
        function generateDailyReport() {
            const reportDate = document.getElementById('reportDate').value;
            
            if (!reportDate) {
                alert('Por favor, selecciona una fecha');
                return;
            }
            
            if (!selectedReportGrupo) {
                alert('Por favor, selecciona un grupo para el reporte');
                return;
            }
            
            // Filtrar asistencia por fecha y materia
            const dateAttendance = attendanceData.filter(record => 
                record.fecha === reportDate && 
                record.materia === 'CULTURA DIGITAL II'
            );
            
            if (dateAttendance.length === 0) {
                alert('No hay datos de asistencia para esta fecha');
                return;
            }
            
            // Filtrar por grupo si no es "TODOS"
            let filteredAttendance = dateAttendance;
            let grupoTitle = "TODOS LOS GRUPOS";
            
            if (selectedReportGrupo !== 'TODOS') {
                filteredAttendance = dateAttendance.filter(record => record.grupo === selectedReportGrupo);
                const grupoInfo = gruposConfig.find(g => g.id === selectedReportGrupo);
                grupoTitle = grupoInfo ? grupoInfo.nombre : `Grupo ${selectedReportGrupo}`;
                
                if (filteredAttendance.length === 0) {
                    alert(`No hay datos de asistencia para ${grupoTitle} en esta fecha`);
                    return;
                }
            }
            
            // Cerrar modal
            document.getElementById('dailyReportModal').style.display = "none";
            
            // Crear PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configuración del documento
            const pageWidth = doc.internal.pageSize.width;
            const margin = 15;
            
            // Título
            doc.setFontSize(20);
            doc.setFont("helvetica", "bold");
            doc.text("REPORTE DE ASISTENCIA DIARIA", pageWidth / 2, 20, { align: "center" });
            
            // Información
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("CULTURA DIGITAL II", pageWidth / 2, 30, { align: "center" });
            
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text(`Grupo: ${grupoTitle}`, pageWidth / 2, 40, { align: "center" });
            
            // Formatear fecha
            const dateObj = new Date(reportDate + 'T00:00:00');
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = dateObj.toLocaleDateString('es-MX', dateOptions);
            
            doc.text(`Fecha: ${formattedDate}`, pageWidth / 2, 47, { align: "center" });
            
            // Fecha de generación
            const now = new Date();
            doc.setFontSize(10);
            doc.text(`Generado: ${now.toLocaleDateString('es-MX')} ${now.toLocaleTimeString('es-MX')}`, pageWidth - margin, 60, { align: "right" });
            
            // Preparar datos para la tabla
            let tableData = [];
            
            if (selectedReportGrupo === 'TODOS') {
                // Reporte de todos los grupos
                const gruposUnicos = Array.from(new Set(filteredAttendance.map(record => record.grupo))).sort();
                let startY = 70;
                
                gruposUnicos.forEach((grupoId, index) => {
                    const grupoAttendance = filteredAttendance.filter(record => record.grupo === grupoId);
                    const grupoInfo = gruposConfig.find(g => g.id === grupoId);
                    const nombreGrupo = grupoInfo ? grupoInfo.nombre : `Grupo ${grupoId}`;
                    
                    // Título de grupo
                    if (startY > 250) {
                        doc.addPage();
                        startY = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.setFont("helvetica", "bold");
                    doc.text(nombreGrupo, margin, startY);
                    
                    // Preparar datos para la tabla de este grupo
                    const grupoTableData = [["No.", "Alumno", "Asistencia"]];
                    
                    // Ordenar por número
                    const sortedAttendance = [...grupoAttendance].sort((a, b) => a.numero - b.numero);
                    
                    sortedAttendance.forEach(record => {
                        grupoTableData.push([
                            record.numero,
                            record.nombre,
                            record.asistio ? "PRESENTE" : "AUSENTE"
                        ]);
                    });
                    
                    // Agregar tabla al PDF
                    doc.autoTable({
                        head: [grupoTableData[0]],
                        body: grupoTableData.slice(1),
                        startY: startY + 5,
                        margin: { left: margin, right: margin },
                        styles: {
                            fontSize: 9,
                            cellPadding: 3,
                        },
                        headStyles: {
                            fillColor: [26, 41, 128],
                            textColor: 255,
                            fontStyle: 'bold'
                        },
                        alternateRowStyles: {
                            fillColor: [240, 240, 240]
                        },
                        columnStyles: {
                            0: { cellWidth: 15 }, // No.
                            1: { cellWidth: 120 }, // Nombre
                            2: { cellWidth: 30 }  // Asistencia
                        },
                        didParseCell: function(data) {
                            // Colorear celdas de asistencia
                            if (data.column.index === 2) {
                                if (data.cell.raw === "PRESENTE") {
                                    data.cell.styles.fillColor = [212, 237, 218];
                                    data.cell.styles.textColor = [21, 87, 36];
                                } else {
                                    data.cell.styles.fillColor = [248, 215, 218];
                                    data.cell.styles.textColor = [114, 28, 36];
                                }
                            }
                        }
                    });
                    
                    startY = doc.lastAutoTable.finalY + 10;
                    
                    // Estadísticas del grupo
                    const total = grupoAttendance.length;
                    const presentes = grupoAttendance.filter(record => record.asistio).length;
                    const ausentes = total - presentes;
                    const porcentaje = total > 0 ? Math.round((presentes / total) * 100) : 0;
                    
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "bold");
                    doc.text("Resumen:", margin, startY);
                    doc.setFont("helvetica", "normal");
                    doc.text(`Presentes: ${presentes} | Ausentes: ${ausentes} | Total: ${total} | Asistencia: ${porcentaje}%`, margin + 20, startY + 5);
                    
                    startY += 15;
                });
                
            } else {
                // Reporte de un grupo específico
                // Preparar datos para la tabla
                tableData = [["No.", "Alumno", "Asistencia"]];
                
                // Ordenar por número
                const sortedAttendance = [...filteredAttendance].sort((a, b) => a.numero - b.numero);
                
                sortedAttendance.forEach(record => {
                    tableData.push([
                        record.numero,
                        record.nombre,
                        record.asistio ? "PRESENTE" : "AUSENTE"
                    ]);
                });
                
                // Agregar tabla al PDF
                doc.autoTable({
                    head: [tableData[0]],
                    body: tableData.slice(1),
                    startY: 70,
                    margin: { left: margin, right: margin },
                    styles: {
                        fontSize: 10,
                        cellPadding: 4,
                    },
                    headStyles: {
                        fillColor: [26, 41, 128],
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [240, 240, 240]
                    },
                    columnStyles: {
                        0: { cellWidth: 15 }, // No.
                        1: { cellWidth: 130 }, // Nombre
                        2: { cellWidth: 30 }  // Asistencia
                    },
                    didParseCell: function(data) {
                        // Colorear celdas de asistencia
                        if (data.column.index === 2) {
                            if (data.cell.raw === "PRESENTE") {
                                data.cell.styles.fillColor = [212, 237, 218];
                                data.cell.styles.textColor = [21, 87, 36];
                            } else {
                                data.cell.styles.fillColor = [248, 215, 218];
                                data.cell.styles.textColor = [114, 28, 36];
                            }
                        }
                    }
                });
                
                // Estadísticas
                const finalY = doc.lastAutoTable.finalY + 10;
                const total = filteredAttendance.length;
                const presentes = filteredAttendance.filter(record => record.asistio).length;
                const ausentes = total - presentes;
                const porcentaje = total > 0 ? Math.round((presentes / total) * 100) : 0;
                
                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.text("RESUMEN", margin, finalY);
                
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text(`Presentes: ${presentes}`, margin, finalY + 10);
                doc.text(`Ausentes: ${ausentes}`, margin, finalY + 17);
                doc.text(`Total: ${total}`, margin, finalY + 24);
                doc.text(`Porcentaje de asistencia: ${porcentaje}%`, margin, finalY + 31);
            }
            
            // Pie de página
            doc.setFontSize(8);
            doc.text("Sistema de Asistencia CULTURA DIGITAL II - Período Agosto-Diciembre 2024", pageWidth / 2, doc.internal.pageSize.height - 10, { align: "center" });
            
            // Guardar PDF
            const fileName = selectedReportGrupo === 'TODOS' 
                ? `Asistencia_CULTURA_DIGITAL_II_${reportDate}_Todos_Grupos.pdf` 
                : `Asistencia_CULTURA_DIGITAL_II_${reportDate}_Grupo_${selectedReportGrupo}.pdf`;
            doc.save(fileName);
        }
        
        // Mostrar modal para reporte semanal
        function showWeeklyReportModal() {
            const modal = document.getElementById('weeklyReportModal');
            
            // Establecer fechas por defecto (esta semana)
            const today = new Date();
            const lastWeek = new Date(today);
            lastWeek.setDate(today.getDate() - 7);
            
            document.getElementById('startDate').value = lastWeek.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            
            // Reiniciar selección
            selectedWeeklyGrupos = ['TODOS'];
            document.querySelectorAll('#weeklyGrupoSelector .grupo-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector('#weeklyGrupoSelector .grupo-option.all').classList.add('selected');
            
            modal.style.display = "block";
        }
        
        // Generar reporte semanal en PDF
        function generateWeeklyReport() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('Por favor, selecciona ambas fechas');
                return;
            }
            
            const start = new Date(startDate + 'T00:00:00');
            const end = new Date(endDate + 'T00:00:00');
            
            if (start > end) {
                alert('La fecha de inicio debe ser anterior a la fecha de fin');
                return;
            }
            
            if (selectedWeeklyGrupos.length === 0) {
                alert('Por favor, selecciona al menos un grupo');
                return;
            }
            
            // Filtrar registros en el rango de fechas para la materia
            const weeklyAttendance = attendanceData.filter(record => {
                const recordDate = new Date(record.fecha + 'T00:00:00');
                return recordDate >= start && 
                       recordDate <= end && 
                       record.materia === 'CULTURA DIGITAL II';
            });
            
            if (weeklyAttendance.length === 0) {
                alert('No hay datos de asistencia en el rango de fechas seleccionado');
                return;
            }
            
            // Filtrar por grupos seleccionadas
            let filteredAttendance = weeklyAttendance;
            let gruposTitle = "TODOS LOS GRUPOS";
            
            if (!selectedWeeklyGrupos.includes('TODOS')) {
                filteredAttendance = weeklyAttendance.filter(record => 
                    selectedWeeklyGrupos.includes(record.grupo)
                );
                
                // Obtener nombres de grupos
                const nombresGrupos = selectedWeeklyGrupos.map(grupoId => {
                    const grupoInfo = gruposConfig.find(g => g.id === grupoId);
                    return grupoInfo ? grupoInfo.nombre : `Grupo ${grupoId}`;
                });
                gruposTitle = nombresGrupos.join(', ');
                
                if (filteredAttendance.length === 0) {
                    alert('No hay datos de asistencia para los grupos seleccionados en este rango de fechas');
                    return;
                }
            }
            
            // Cerrar modal
            document.getElementById('weeklyReportModal').style.display = "none";
            
            // Crear PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configuración del documento
            const pageWidth = doc.internal.pageSize.width;
            const margin = 15;
            
            // Título
            doc.setFontSize(20);
            doc.setFont("helvetica", "bold");
            doc.text("REPORTE DE ASISTENCIA SEMANAL", pageWidth / 2, 20, { align: "center" });
            
            // Información
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("CULTURA DIGITAL II", pageWidth / 2, 30, { align: "center" });
            
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text(`Grupo(s): ${gruposTitle}`, pageWidth / 2, 40, { align: "center" });
            
            // Formatear fechas
            const dateOptions = { day: 'numeric', month: 'long' };
            const formattedStart = start.toLocaleDateString('es-MX', dateOptions);
            const formattedEnd = end.toLocaleDateString('es-MX', dateOptions);
            
            doc.text(`Período: ${formattedStart} al ${formattedEnd}`, pageWidth / 2, 47, { align: "center" });
            
            // Fecha de generación
            const now = new Date();
            doc.setFontSize(10);
            doc.text(`Generado: ${now.toLocaleDateString('es-MX')} ${now.toLocaleTimeString('es-MX')}`, pageWidth - margin, 60, { align: "right" });
            
            if (selectedWeeklyGrupos.includes('TODOS')) {
                // Reporte para todos los grupos
                const gruposUnicos = Array.from(new Set(filteredAttendance.map(record => record.grupo))).sort();
                let startY = 70;
                
                gruposUnicos.forEach(grupoId => {
                    const grupoAttendance = filteredAttendance.filter(record => record.grupo === grupoId);
                    const grupoInfo = gruposConfig.find(g => g.id === grupoId);
                    const nombreGrupo = grupoInfo ? grupoInfo.nombre : `Grupo ${grupoId}`;
                    
                    // Obtener todas las fechas únicas en el rango para este grupo
                    const fechasUnicas = Array.from(new Set(grupoAttendance.map(record => record.fecha))).sort();
                    
                    // Crear tabla por alumno para este grupo
                    const alumnosUnicos = Array.from(new Set(grupoAttendance.map(record => `${record.numero}_${record.nombre}`)));
                    
                    // Preparar matriz de datos
                    const tableData = [];
                    
                    // Encabezados
                    const headers = ["No.", "Alumno", ...fechasUnicas.map(f => formatDateForReport(f)), "Total Asist."];
                    tableData.push(headers);
                    
                    // Procesar cada alumno
                    alumnosUnicos.forEach(alumnoKey => {
                        const [numStr, ...nombreParts] = alumnoKey.split('_');
                        const numero = parseInt(numStr);
                        const nombre = nombreParts.join('_');
                        
                        const row = [numero, nombre];
                        let totalAsistencias = 0;
                        let totalRegistros = 0;
                        
                        // Para cada fecha
                        fechasUnicas.forEach(fecha => {
                            const asistenciaFecha = grupoAttendance.filter(record => 
                                record.numero === numero && 
                                record.nombre === nombre && 
                                record.fecha === fecha
                            );
                            
                            if (asistenciaFecha.length > 0) {
                                // Si hay registro para esa fecha
                                const asistio = asistenciaFecha[0].asistio;
                                totalRegistros++;
                                if (asistio) {
                                    row.push("✓");
                                    totalAsistencias++;
                                } else {
                                    row.push("✗");
                                }
                            } else {
                                row.push("-");
                            }
                        });
                        
                        // Calcular porcentaje de asistencia
                        const porcentaje = totalRegistros > 0 ? Math.round((totalAsistencias / totalRegistros) * 100) : 0;
                        row.push(`${porcentaje}%`);
                        
                        tableData.push(row);
                    });
                    
                    // Título del grupo
                    if (startY > 250) {
                        doc.addPage();
                        startY = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.setFont("helvetica", "bold");
                    doc.text(nombreGrupo, margin, startY);
                    
                    // Agregar tabla al PDF
                    doc.autoTable({
                        head: [tableData[0]],
                        body: tableData.slice(1),
                        startY: startY + 5,
                        margin: { left: margin, right: margin },
                        styles: {
                            fontSize: 8,
                            cellPadding: 2,
                        },
                        headStyles: {
                            fillColor: [26, 41, 128],
                            textColor: 255,
                            fontStyle: 'bold'
                        },
                        alternateRowStyles: {
                            fillColor: [240, 240, 240]
                        },
                        columnStyles: {
                            0: { cellWidth: 15 }, // No.
                            1: { cellWidth: 80 }, // Nombre
                        },
                        didParseCell: function(data) {
                            // Colorear celdas de asistencia por fecha
                            if (data.column.index >= 2 && data.column.index < headers.length - 1) {
                                if (data.cell.raw === "✓") {
                                    data.cell.styles.fillColor = [212, 237, 218];
                                    data.cell.styles.textColor = [21, 87, 36];
                                } else if (data.cell.raw === "✗") {
                                    data.cell.styles.fillColor = [248, 215, 218];
                                    data.cell.styles.textColor = [114, 28, 36];
                                }
                            }
                            
                            // Colorear porcentaje final
                            if (data.column.index === headers.length - 1) {
                                const porcentaje = parseInt(data.cell.raw);
                                if (!isNaN(porcentaje)) {
                                    if (porcentaje >= 80) {
                                        data.cell.styles.fillColor = [212, 237, 218];
                                        data.cell.styles.textColor = [21, 87, 36];
                                    } else if (porcentaje >= 60) {
                                        data.cell.styles.fillColor = [255, 243, 205];
                                        data.cell.styles.textColor = [133, 100, 4];
                                    } else {
                                        data.cell.styles.fillColor = [248, 215, 218];
                                        data.cell.styles.textColor = [114, 28, 36];
                                    }
                                }
                            }
                        }
                    });
                    
                    startY = doc.lastAutoTable.finalY + 10;
                });
                
            } else {
                // Reporte para un grupo específico
                const grupoId = selectedWeeklyGrupos[0];
                const grupoAttendance = filteredAttendance;
                const grupoInfo = gruposConfig.find(g => g.id === grupoId);
                const nombreGrupo = grupoInfo ? grupoInfo.nombre : `Grupo ${grupoId}`;
                
                // Obtener todas las fechas únicas en el rango
                const fechasUnicas = Array.from(new Set(grupoAttendance.map(record => record.fecha))).sort();
                
                // Crear tabla por alumno
                const alumnosUnicos = Array.from(new Set(grupoAttendance.map(record => `${record.numero}_${record.nombre}`)));
                
                // Preparar matriz de datos
                const tableData = [];
                
                // Encabezados
                const headers = ["No.", "Alumno", ...fechasUnicas.map(f => formatDateForReport(f)), "Total Asist."];
                tableData.push(headers);
                
                // Procesar cada alumno
                alumnosUnicos.forEach(alumnoKey => {
                    const [numStr, ...nombreParts] = alumnoKey.split('_');
                    const numero = parseInt(numStr);
                    const nombre = nombreParts.join('_');
                    
                    const row = [numero, nombre];
                    let totalAsistencias = 0;
                    let totalRegistros = 0;
                    
                    // Para cada fecha
                    fechasUnicas.forEach(fecha => {
                        const asistenciaFecha = grupoAttendance.filter(record => 
                            record.numero === numero && 
                            record.nombre === nombre && 
                            record.fecha === fecha
                        );
                        
                        if (asistenciaFecha.length > 0) {
                            // Si hay registro para esa fecha
                            const asistio = asistenciaFecha[0].asistio;
                            totalRegistros++;
                            if (asistio) {
                                row.push("✓");
                                totalAsistencias++;
                            } else {
                                row.push("✗");
                            }
                        } else {
                            row.push("-");
                        }
                    });
                    
                    // Calcular porcentaje de asistencia
                    const porcentaje = totalRegistros > 0 ? Math.round((totalAsistencias / totalRegistros) * 100) : 0;
                    row.push(`${porcentaje}%`);
                    
                    tableData.push(row);
                });
                
                // Agregar tabla al PDF
                doc.autoTable({
                    head: [tableData[0]],
                    body: tableData.slice(1),
                    startY: 70,
                    margin: { left: margin, right: margin },
                    styles: {
                        fontSize: 8,
                        cellPadding: 2,
                    },
                    headStyles: {
                        fillColor: [26, 41, 128],
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [240, 240, 240]
                    },
                    columnStyles: {
                        0: { cellWidth: 15 }, // No.
                        1: { cellWidth: 80 }, // Nombre
                    },
                    didParseCell: function(data) {
                        // Colorear celdas de asistencia por fecha
                        if (data.column.index >= 2 && data.column.index < headers.length - 1) {
                            if (data.cell.raw === "✓") {
                                data.cell.styles.fillColor = [212, 237, 218];
                                data.cell.styles.textColor = [21, 87, 36];
                            } else if (data.cell.raw === "✗") {
                                data.cell.styles.fillColor = [248, 215, 218];
                                data.cell.styles.textColor = [114, 28, 36];
                            }
                        }
                        
                        // Colorear porcentaje final
                        if (data.column.index === headers.length - 1) {
                            const porcentaje = parseInt(data.cell.raw);
                            if (!isNaN(porcentaje)) {
                                if (porcentaje >= 80) {
                                    data.cell.styles.fillColor = [212, 237, 218];
                                    data.cell.styles.textColor = [21, 87, 36];
                                } else if (porcentaje >= 60) {
                                    data.cell.styles.fillColor = [255, 243, 205];
                                    data.cell.styles.textColor = [133, 100, 4];
                                } else {
                                    data.cell.styles.fillColor = [248, 215, 218];
                                    data.cell.styles.textColor = [114, 28, 36];
                                }
                            }
                        }
                    }
                });
                
                // Estadísticas finales
                const finalY = doc.lastAutoTable.finalY + 10;
                
                // Calcular estadísticas generales
                let totalRegistros = 0;
                let totalPresentes = 0;
                
                grupoAttendance.forEach(record => {
                    totalRegistros++;
                    if (record.asistio) {
                        totalPresentes++;
                    }
                });
                
                const promedioGeneral = totalRegistros > 0 ? Math.round((totalPresentes / totalRegistros) * 100) : 0;
                
                doc.setFontSize(11);
                doc.setFont("helvetica", "bold");
                doc.text("RESUMEN GENERAL", margin, finalY);
                
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text(`Total de registros: ${totalRegistros}`, margin, finalY + 8);
                doc.text(`Total de asistencias: ${totalPresentes}`, margin, finalY + 16);
                doc.text(`Promedio general de asistencia: ${promedioGeneral}%`, margin, finalY + 24);
            }
            
            // Pie de página
            doc.setFontSize(8);
            doc.text("Sistema de Asistencia CULTURA DIGITAL II - Período Agosto-Diciembre 2024", pageWidth / 2, doc.internal.pageSize.height - 10, { align: "center" });
            
            // Guardar PDF
            const fileName = selectedWeeklyGrupos.includes('TODOS') 
                ? `Asistencia_CULTURA_DIGITAL_II_${startDate}_al_${endDate}_Todos_Grupos.pdf` 
                : `Asistencia_CULTURA_DIGITAL_II_${startDate}_al_${endDate}_Grupo_${selectedWeeklyGrupos[0]}.pdf`;
            doc.save(fileName);
        }
        
        // Formatear fecha para reporte (formato corto)
        function formatDateForReport(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('es-MX', { day: '2-digit', month: 'short' });
        }
        
        // Mostrar modal con todos los datos
        function showAllDataModal() {
            const modal = document.getElementById('dataModal');
            const modalContent = document.getElementById('modalContent');
            
            if (attendanceData.length === 0) {
                modalContent.innerHTML = '<p>No hay datos de asistencia registrados.</p>';
                modal.style.display = "block";
                return;
            }
            
            // Ordenar datos por fecha (más reciente primero)
            const sortedData = [...attendanceData].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            let html = '<h3>Todos los Registros de Asistencia - CULTURA DIGITAL II</h3>';
            html += `<p>Total de registros: ${attendanceData.length}</p>`;
            
            // Agrupar por fecha
            const datosPorFecha = {};
            sortedData.forEach(record => {
                if (!datosPorFecha[record.fecha]) {
                    datosPorFecha[record.fecha] = [];
                }
                datosPorFecha[record.fecha].push(record);
            });
            
            // Mostrar por fecha
            for (const [fecha, registros] of Object.entries(datosPorFecha)) {
                const dateObj = new Date(fecha + 'T00:00:00');
                const formattedDate = dateObj.toLocaleDateString('es-MX', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                html += `<div style="margin-top: 20px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">`;
                html += `<h4>${formattedDate}</h4>`;
                
                // Agrupar por grupo
                const porGrupo = {};
                registros.forEach(record => {
                    if (!porGrupo[record.grupo]) {
                        porGrupo[record.grupo] = [];
                    }
                    porGrupo[record.grupo].push(record);
                });
                
                for (const [grupoId, records] of Object.entries(porGrupo)) {
                    const grupoInfo = gruposConfig.find(g => g.id === grupoId);
                    const nombreGrupo = grupoInfo ? grupoInfo.nombre : `Grupo ${grupoId}`;
                    
                    const presentes = records.filter(r => r.asistio).length;
                    const total = records.length;
                    const porcentaje = Math.round((presentes / total) * 100);
                    
                    html += `<p><strong>${nombreGrupo}:</strong> ${presentes}/${total} (${porcentaje}%)</p>`;
                }
                
                html += `</div>`;
            }
            
            modalContent.innerHTML = html;
            modal.style.display = "block";
        }
        
        // Limpiar datos del grupo seleccionado
        function clearGrupoData() {
            if (!currentGrupo) {
                alert('Por favor, selecciona un grupo primero');
                return;
            }
            
            if (confirm(`¿Estás seguro de que deseas eliminar TODOS los datos de asistencia del grupo ${currentGrupo}? Esta acción no se puede deshacer.`)) {
                // Eliminar datos de alumnos del grupo
                if (alumnosData[currentGrupo]) {
                    delete alumnosData[currentGrupo];
                }
                
                // Eliminar registros de asistencia del grupo
                attendanceData = attendanceData.filter(record => record.grupo !== currentGrupo);
                
                saveData();
                updateDailySummary();
                updateGruposInfo();
                
                // Actualizar interfaz
                document.getElementById('takeAttendance').innerHTML = 
                    `<i class="fas fa-clipboard-check"></i> Tomar Asistencia`;
                
                alert(`Todos los datos del grupo ${currentGrupo} han sido eliminados.`);
            }
        }
        
        // Limpiar TODOS los datos
        function clearAllData() {
            if (confirm('¿Estás seguro de que deseas eliminar TODOS los datos de asistencia de TODOS los grupos? Esta acción no se puede deshacer.')) {
                // Limpiar todas las listas de alumnos
                alumnosData = {};
                
                // Limpiar todos los registros de asistencia
                attendanceData = [];
                
                saveData();
                updateDailySummary();
                updateGruposInfo();
                
                // Resetear botón de tomar asistencia
                if (currentGrupo) {
                    document.getElementById('takeAttendance').innerHTML = 
                        `<i class="fas fa-clipboard-check"></i> Tomar Asistencia`;
                }
                
                alert('Todos los datos han sido eliminados.');
            }
        }
        
        // Guardar datos en localStorage
        function saveData() {
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            localStorage.setItem('alumnosData', JSON.stringify(alumnosData));
        }
        
        // Cargar datos desde localStorage
        function loadSavedData() {
            const savedAttendance = localStorage.getItem('attendanceData');
            const savedAlumnos = localStorage.getItem('alumnosData');
            
            if (savedAttendance) {
                attendanceData = JSON.parse(savedAttendance);
            }
            
            if (savedAlumnos) {
                alumnosData = JSON.parse(savedAlumnos);
                updateGruposInfo();
            }
        }
    </script>
</body>

</html>
